#!/bin/bash
###########################################################
# Copyright (c) 2015, Blockbridge Networks LLC.  All rights reserved.
# Use of this source code is governed by a BSD-style license, found
# in the LICENSE file.
#
# Blockbridge docker volume plugin
###########################################################

###########################################################
# Required parameters
###########################################################
: ${BLOCKBRIDGE_API_HOST="srust-dev2"}
: ${BLOCKBRIDGE_API_KEY="1/9NqH7BV3OUsaIZOhA+w07TyuvZWnmfpuhATKJg2+xlTk2ofsFXczCg"}

###########################################################
# Check for docker
###########################################################
VERSION=$(docker version -f '{{.Client.Version}}' 2>&1)
if [ $? -ne 0 ]; then
    echo "Unable to determine docker version. Make sure docker 1.8.0+ is installed."
    echo "$(docker version)"
    exit 1
fi

if [[ ! "$VERSION" =~ "1.8" ]]; then
    echo "Docker 1.8.0+ version not found. Please upgrade to docker 1.8.0+."
    echo "$(docker version)"
    exit 1
fi

###########################################################
# run blockbridge docker volume plugin
###########################################################
docker rm -fv blockbridge-volume-driver

docker run --name blockbridge-volume-driver                             \
           --detach                                                     \
           --restart always                                             \
           --volume /bb/env:/bb/env                                     \
           --volume /run/docker/plugins/blockbridge:/run/docker/plugins/blockbridge   \
           --volume /run/docker.sock:/run/docker.sock                   \
           -e BLOCKBRIDGE_API_HOST=$BLOCKBRIDGE_API_HOST                \
           -e BLOCKBRIDGE_API_KEY=$BLOCKBRIDGE_API_KEY                  \
           blockbridge/volume-driver

docker logs -f blockbridge-volume-driver
